# Nginx Reverse Proxy for Dgraph

This nginx service acts as a reverse proxy and API gateway for the Dgraph service, providing:

- **API Token Authentication** - Protects Dgraph endpoints with token-based auth
- **Rate Limiting** - Prevents API abuse with configurable limits
- **CORS Support** - Enables cross-origin requests for web applications
- **Health Monitoring** - Dedicated health check endpoint

## üîê Authentication

The proxy requires an API token for all requests (except `/health`).

### Token Headers

Provide the token using either format:

1. **X-Api-Token header**:
   ```bash
   curl -H "X-Api-Token: your-token-here" https://dgraph-proxy.onrender.com/graphql
   ```

2. **Authorization Bearer header**:
   ```bash
   curl -H "Authorization: Bearer your-token-here" https://dgraph-proxy.onrender.com/graphql
   ```

## üéØ Endpoints

### Health Check (No Auth Required)
```bash
GET /health
# Returns: "nginx proxy healthy"
```

### Root Endpoint (No Auth Required)
```bash
GET /
# Returns: {"message": "Nginx proxy is running", "dgraph_endpoint": "/dgraph"}
```

### Protected Dgraph Endpoints (Auth Required)
All `/dgraph/*` endpoints are proxied to the internal `dgraph-standalone` service:

- `/dgraph/graphql` - GraphQL endpoint
- `/dgraph/admin` - Admin API
- `/dgraph/alter` - Schema alterations
- `/dgraph/query` - DQL queries
- `/dgraph/*` - All other Dgraph endpoints

## üöÄ Usage Examples

### GraphQL Query
```bash
curl -X POST https://dgraph-proxy.onrender.com/dgraph/graphql \
  -H "Content-Type: application/json" \
  -H "X-Api-Token: YOUR_TOKEN_HERE" \
  -d '{"query": "{ queryUser { name email } }"}'
```

### Admin Schema
```bash
curl -X GET https://dgraph-proxy.onrender.com/dgraph/admin/schema \
  -H "X-Api-Token: YOUR_TOKEN_HERE"
```

### DQL Query
```bash
curl -X POST https://dgraph-proxy.onrender.com/dgraph/query \
  -H "Content-Type: application/json" \
  -H "X-Api-Token: YOUR_TOKEN_HERE" \
  -d '{"query": "{ user(func: type(User)) { name } }"}'
```

## ‚öôÔ∏è Configuration

### Rate Limiting
- **Default**: 10 requests/second per IP
- **Burst**: Up to 20 requests in burst
- **Zone**: 10MB memory for tracking

### CORS
- **Origins**: All origins allowed (`*`)
- **Methods**: GET, POST, PUT, DELETE, OPTIONS
- **Headers**: Includes auth headers and Dgraph-specific headers

### Proxy Settings
- **Upstream**: Dynamic internal service URL (e.g., `dgraph-standalone-0bd2:8080`)
- **Service Discovery**: Uses Render's `fromService` to get actual deployed hostname
- **Timeouts**: 60 seconds for connect/send/read
- **WebSocket**: Supported for subscriptions

## üîí Security Features

1. **Token Validation** - All requests validated against environment token
2. **Rate Limiting** - Prevents abuse and DoS attacks  
3. **Header Sanitization** - Proper header forwarding
4. **Internal Routing** - Uses Render's internal service names

## üõ†Ô∏è Local Testing

### Build and Run
```bash
cd nginx-proxy/
docker build -t nginx-proxy .
docker run -p 8080:80 -e api_token="test-token-123" nginx-proxy
```

### Test Authentication
```bash
# Should work
curl -H "X-Api-Token: test-token-123" http://localhost:8080/health

# Should fail with 401
curl http://localhost:8080/admin/schema
```

## üîß Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `api_token` | Authentication token for API access | Yes |

The token is automatically generated by Render when `generateValue: true` is set in `render.yaml`.

## üìä Monitoring

### Health Check
The `/health` endpoint is available without authentication for monitoring:

```bash
curl https://dgraph-proxy.onrender.com/health
# Returns: "nginx proxy healthy"
```

### Logs
Monitor nginx access and error logs through the Render dashboard for:
- Failed authentication attempts
- Rate limit violations
- Proxy errors
- Request patterns

## üîÑ Architecture

```
Client Request
     ‚Üì
[Nginx Proxy] ‚Üê API Token Validation
     ‚Üì
[Rate Limiting]
     ‚Üì  
[CORS Headers]
     ‚Üì
[Internal Dgraph Service]
```

The proxy sits between external clients and your Dgraph service, providing a secure and controlled access layer while maintaining full Dgraph functionality.
